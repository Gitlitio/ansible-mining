#!/usr/bin/env python3
import json
import subprocess
import sys
import traceback

if __name__ == '__main__':
    stats = [
        'accounting.buffer_size',
        'accounting.mode',
        'clocks.current.graphics',
        'clocks.current.memory',
        'clocks.current.sm',
        'clocks.current.video',
        'clocks.max.graphics',
        'clocks.max.memory',
        'clocks.max.sm',
        'clocks_throttle_reasons.active',
        'clocks_throttle_reasons.applications_clocks_setting',
        'clocks_throttle_reasons.gpu_idle',
        'clocks_throttle_reasons.hw_slowdown',
        'clocks_throttle_reasons.supported',
        'clocks_throttle_reasons.sw_power_cap',
        'clocks_throttle_reasons.sync_boost',
        'compute_mode',
        'count',
        'display_active',
        'display_mode',
        'driver_version',
        'encoder.stats.averageFps',
        'encoder.stats.averageLatency',
        'encoder.stats.sessionCount',
        'enforced.power.limit',
        'fan.speed',
        'index',
        'memory.free',
        'memory.total',
        'memory.used',
        'name',
        'persistence_mode',
        'power.default_limit',
        'power.draw',
        'power.limit',
        'power.management',
        'power.max_limit',
        'power.min_limit',
        'pstate',
        'temperature.gpu',
        'temperature.memory',
        'utilization.gpu',
        'utilization.memory',
        'uuid',
        'vbios_version',
    ]

    # noinspection PyBroadException
    try:
        output = subprocess.check_output(
            [
                'nvidia-smi',
                '--format=noheader,nounits,csv',
                '--query-gpu={}'.format(','.join(stats))
            ],
            stderr=subprocess.STDOUT
        )
        all_gpu_stats = []
        for line in output.splitlines(False):
            values = [x.strip() for x in line.split(b',')]
            gpu_stats = {}
            for name, value in zip(stats, [x.strip() for x in line.split(b',')]):
                # noinspection PyBroadException
                try:
                    gpu_stats[name] = float(value)
                except:
                    pass
            all_gpu_stats.append(gpu_stats)
        json.dump(all_gpu_stats, sys.stdout)
        sys.exit(0)
    except Exception as e:
        traceback.print_exc(file=sys.stderr)
        sys.exit(1)
